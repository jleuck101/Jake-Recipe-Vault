<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Jake's Recipe Vault</title>
  <meta name="theme-color" content="#0b0c10" />
  <style>
    :root{
      --bg:#0b0c10;
      --panel:#12141b;
      --panel2:#171a23;
      --text:#eef2ff;
      --muted:rgba(238,242,255,.72);
      --line:rgba(255,255,255,.12);
      --accent:#7c3aed;
      --ok:#22c55e;
      --danger:#ef4444;
      --shadow: 0 16px 50px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:linear-gradient(180deg,#070812 0%,var(--bg) 70%);
      color:var(--text);
    }
    a{color:#c4b5fd;text-decoration:none}
    a:hover{text-decoration:underline}

    header{
      position:sticky; top:0; z-index:20;
      background:rgba(11,12,16,.86);
      backdrop-filter: blur(12px);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:12px 14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    h1{margin:0;font-size:18px;letter-spacing:.2px}
    .hint{font-size:12px;color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace}

    .btn{
      border:1px solid var(--line);
      background:var(--panel2);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:850;
      box-shadow:0 0 0 rgba(0,0,0,0);
      user-select:none;
    }
    .btn:hover{border-color:rgba(255,255,255,.22)}
    .btn.primary{background:var(--accent);border-color:rgba(124,58,237,.55)}
    .btn.ok{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.35);color:#bbf7d0}
    .btn.danger{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35);color:#fecaca}
    .btn.ghost{background:transparent}
    .btn.small{padding:8px 10px;border-radius:10px;font-size:12px}

    .btnSm{
  padding:6px 10px;
  border-radius:10px;
  font-size:12px;
  font-weight:850;
  line-height:1;
}

.scaleTools{
  display:flex;
  flex-direction:column;
  align-items:flex-end;
  gap:6px;
}

.scaleBtns{
  display:flex;
  gap:8px;
  align-items:center;
  flex-wrap:wrap;
  justify-content:flex-end;
}

.scaleServings{
  display:flex;
  gap:8px;
  align-items:center;
  flex-wrap:wrap;
  justify-content:flex-end;
}

.scaleInput{
  width:84px;
  padding:6px 8px;
  border-radius:10px;
  border:1px solid var(--line);
  background:var(--panel2);
  color:var(--text);
}

.mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace; }


    input,select,textarea{
      width:100%;
      border:1px solid var(--line);
      background:var(--panel);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      outline:none;
    }
    textarea{min-height:120px;resize:vertical}

    /* Page layout */
    .main{max-width:1200px;margin:0 auto;padding:14px}
    .filters{
      display:grid;
      grid-template-columns: 1.5fr 1fr 1fr 1fr;
      gap:10px;
      align-items:end;
    }
    @media(max-width:980px){
      .filters{grid-template-columns:1fr 1fr; }
    }
    @media(max-width:520px){
      .filters{grid-template-columns:1fr; }
    }
    .k{font-size:12px;color:var(--muted);margin-bottom:6px}

    /* Gallery grid */
    .galleryTop{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      margin-top:12px;
    }
    .seg{
      display:flex;gap:8px;align-items:center;flex-wrap:wrap;
    }
    .seg .btn{padding:8px 10px;font-size:12px}
    .seg input[type="range"]{width:170px}
    .count{color:var(--muted);font-size:12px}

    .grid{
      display:grid;
      gap:12px;
      margin-top:12px;
      grid-template-columns: repeat(4, minmax(0,1fr));
    }
    @media(max-width:1100px){.grid{grid-template-columns: repeat(3, minmax(0,1fr));}}
    @media(max-width:800px){.grid{grid-template-columns: repeat(2, minmax(0,1fr));}}
    @media(max-width:520px){.grid{grid-template-columns: repeat(2, minmax(0,1fr));}}
    @media(max-width:520px){.tileBody{padding:12px 12px 14px}}
    @media(max-width:520px){.tileTitle{font-size:16px}}

    .tile{
      border:1px solid var(--line);
      background:rgba(18,20,27,.65);
      border-radius:18px;
      overflow:hidden;
      cursor:pointer;
      box-shadow:0 8px 24px rgba(0,0,0,.18);
      transition: transform .10s ease, border-color .10s ease;
    }
    .tile:hover{border-color:rgba(255,255,255,.22); transform: translateY(-1px);}
    .imgBox{position:relative; aspect-ratio: 4 / 3; background:rgba(255,255,255,.03)}
    .imgBox img{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover;
      display:block;
    }
    .imgFallback{
      position:absolute; inset:0;
      display:flex;align-items:center;justify-content:center;
      color:rgba(238,242,255,.45);
      font-size:12px;
    }
    .tileBody{padding:10px 10px 12px}
    .tileTitle{font-weight:950;line-height:1.2; letter-spacing:.2px}
    .tileMeta{
      margin-top:8px;
      display:flex;gap:8px;flex-wrap:wrap;
      color:rgba(238,242,255,.72);
      font-size:12px;
    }
    .pill{
      font-size:12px;padding:3px 8px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
    }

    /* Edit suggestions (clickable chips) */
    .suggestRow{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px;
    }
    .chipBtn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:6px 10px;
      border-radius:999px;
      cursor:pointer;
      font-weight:800;
      font-size:12px;
    }
    .chipBtn:hover{ border-color:rgba(255,255,255,.22); }


    .badge{
      display:inline-flex;align-items:center;gap:6px;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:rgba(34,197,94,.9);display:inline-block}

    /* Viewer modal (full screen on mobile) */
    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.65);
      display:none;
      z-index:50;
    }
    .overlay.show{display:block}
    .viewer{
      position:fixed; inset:0;
      display:none;
      z-index:60;
      background:linear-gradient(180deg, rgba(7,8,18,.98) 0%, rgba(11,12,16,.98) 60%);
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }
    .viewer.show{display:block}
    .viewerInner{max-width:900px;margin:0 auto;padding:14px}
    .viewerTop{
      position:sticky; top:0; z-index:80;
      background:rgba(11,12,16,.86);
      backdrop-filter: blur(12px);
      border-bottom:1px solid var(--line);
    }
    .viewerTop .wrap{max-width:900px}
    .viewerHeader{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .viewerTitle{font-size:18px;font-weight:950;letter-spacing:.2px;margin:0}
    .viewerSub{font-size:12px;color:var(--muted);margin-top:4px}
    .viewerHero{
      margin-top:14px;
      border:1px solid var(--line);
      border-radius:18px;
      overflow:hidden;
      box-shadow: var(--shadow);
      background:rgba(255,255,255,.03);
    }
    .viewerHero img{width:100%;height:auto;display:block;max-height:420px;object-fit:cover}
    .section{
      margin-top:14px;
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(18,20,27,.65);
      overflow:hidden;
    }
    .sectionHd{
      padding:12px;
      border-bottom:1px solid var(--line);
      background:rgba(23,26,35,.55);
      display:flex;justify-content:space-between;gap:10px;align-items:center;
      flex-wrap:wrap;
    }
    .sectionBd{padding:12px}
    .h2{margin:0;font-size:14px;font-weight:950;letter-spacing:.2px}

    .pre{
      white-space:pre-wrap;
      line-height:1.55;
      font-size:14px;
      color:rgba(238,242,255,.92);
    }
    .kv{display:flex;gap:10px;flex-wrap:wrap;color:rgba(238,242,255,.78);font-size:12px}
    .kv .pill{background:rgba(255,255,255,.03)}
    .viewerFooterSpace{height:18px}

    /* Ingredients bullets + checkboxes */
    .ingList{
      list-style: none;
      padding:0;
      margin:0;
      display:grid;
      gap:10px;
    }
    .ingItem{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:10px 10px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      border-radius:14px;
    }
    .ingItem input{
      width:auto;
      margin-top:2px;
      transform: scale(1.15);
      accent-color: var(--accent);
    }
    .ingText{
      line-height:1.5;
      font-size:14px;
      color:rgba(238,242,255,.92);
      flex:1;
    }
    .ingText.checked{
      opacity:.60;
      text-decoration: line-through;
    }
    .ingHeader{
      font-weight:950;
      letter-spacing:.2px;
      padding:10px 10px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(124,58,237,.14);
      border-radius:14px;
    }

    /* Edit modal inside viewer */
    .editPanel{
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(18,20,27,.80);
      overflow:hidden;
      margin-top:14px;
      display:none;
    }
    .editPanel.show{display:block}

    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:650px){.two{grid-template-columns:1fr}}

    /* Snackbar */
    .snack{
      position:fixed;
      left:50%;
      bottom:14px;
      transform:translateX(-50%);
      display:none;
      gap:10px;
      align-items:center;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(18,20,27,.92);
      box-shadow: var(--shadow);
      z-index:999;
      max-width:min(900px, calc(100vw - 28px));
    }
    .snack.show{display:flex}
    .snackMsg{color:rgba(238,242,255,.92); font-size:13px}

        /* Cook Mode (bigger, easier to read on phone) */
    body.cookMode .viewerInner{ font-size: 18px; }
    body.cookMode .pre{ font-size: 18px; line-height: 1.65; }
    body.cookMode .ingText{ font-size: 18px; line-height: 1.65; }
    body.cookMode .viewerTitle{ font-size: 22px; }
    body.cookMode .sectionBd{ padding: 14px; }
    body.cookMode .ingItem{ padding: 12px 12px; }
    body.cookMode .ingItem input{ transform: scale(1.35); }

  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="row">
      <div>
        <h1>Jake's Recipe Vault</h1>
        <div class="hint">
          Big-photo gallery • Tap a recipe to open a clean cooking view • <span id="cloud"></span> <span id="status"></span>
        </div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <button class="btn primary" id="newBtn">+ New</button>
      </div>
    </div>
  </div>
</header>

<main class="main">
  <div class="filters">
    <div>
      <div class="k">Search</div>
      <input id="q" placeholder="Search title, ingredients, directions, tags…" />
    </div>
    <div>
      <div class="k">Cuisine</div>
      <select id="cuisineF"><option value="">Any</option></select>
    </div>
    <div>
      <div class="k">Appliance</div>
      <select id="applianceF"><option value="">Any</option></select>
    </div>
    <div>
      <div class="k">Max time (min)</div>
      <input id="maxTime" type="number" min="0" step="5" placeholder="e.g. 30" />
    </div>
  </div>

  <div class="galleryTop">
    <div class="seg">
      <div class="k" style="margin:0;">Card size (← smaller • larger →)</div>
      <input id="size" type="range" min="2" max="6" value="4" />
      <select id="sort" style="max-width:240px">
        <option value="updated">Sort: Recently updated</option>
        <option value="title">Sort: Title A→Z</option>
        <option value="cooked">Sort: Most cooked</option>
        <option value="time">Sort: Shortest time</option>
      </select>
    </div>
    <div class="count"><span id="count">0</span> recipes</div>
  </div>

  <div class="grid" id="grid"></div>
</main>

<!-- Overlay + viewer -->
<div class="overlay" id="overlay"></div>

<div class="viewer" id="viewer" aria-hidden="true">
  <div class="viewerTop">
    <div class="wrap">
      <div class="viewerHeader">
        <button class="btn ghost" id="backBtn">← Back</button>
        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
  <button class="btn small ok" id="markCookedBtn" title="Prevents double-taps; offers Undo">Cooked +1</button>
  <button class="btn small" id="copyGroceriesBtn" title="Copy ingredients to paste into Apple Reminders">Copy groceries</button>
  <button class="btn small" id="downloadGroceriesBtn" title="Download ingredients as a .txt file">Groceries .txt</button>
  <button class="btn small" id="downloadOneBtn" title="Downloads a clean 1-page recipe card (uses your current scaling)">Download recipe</button>
  <button class="btn" id="printBtn">Print Card</button>
  <button class="btn small" id="cookModeBtn" title="Bigger text + tries to keep screen awake">Cook Mode</button>
  <button class="btn small primary" id="editToggleBtn">Edit</button>
  <button class="btn small danger" id="deleteBtn">Delete</button>
</div>

      </div>
    </div>
  </div>

  <div class="viewerInner">
    <h2 class="viewerTitle" id="vTitle"></h2>
    <div class="viewerSub" id="vSub"></div>
<div class="viewerSub" id="wakeHint" style="display:none;"></div>


    <div class="viewerHero" id="vHero" style="display:none;">
      <img id="vImg" alt="" />
    </div>

    <div class="section">
      <div class="sectionHd">
        <div class="h2">Quick info</div>
        <div class="kv" id="vInfo"></div>
      </div>
      <div class="sectionBd">
        <div class="hint" id="vSource"></div>
      </div>
    </div>

    <div class="section">
  <div class="sectionHd">
    <div>
      <div class="h2">Ingredients</div>
      <div class="hint">Tap checkboxes as you cook (saved on this device)</div>
    </div>

    <div class="scaleTools" aria-label="Scale recipe">
      <div class="scaleBtns">
        <span class="pill">Scale</span>
        <button class="btn btnSm" id="scaleDown" type="button" title="Decrease">−</button>
        <button class="btn btnSm" id="scaleReset" type="button" title="Reset to 1×">1×</button>
        <button class="btn btnSm" id="scaleUp" type="button" title="Increase">+</button>
      </div>

      <div class="scaleServings" id="scaleServingsRow" style="display:none;">
        <span class="muted">Servings</span>
        <span id="scaleServingsBase" class="mono"></span>
        <span class="muted">→</span>
        <input id="scaleServingsTarget" class="scaleInput" type="number" min="0.5" step="0.5" inputmode="decimal" />
      </div>

      <div class="hint" id="scaleMeta"></div>
    </div>
  </div>

  <div class="sectionBd">
    <div id="vIngredients"></div>
  </div>
</div>


    <div class="section">
      <div class="sectionHd"><div class="h2">Directions</div></div>
      <div class="sectionBd"><div class="pre" id="vDirections"></div></div>
    </div>

    <div class="section" id="vNotesWrap" style="display:none;">
      <div class="sectionHd"><div class="h2">Notes</div></div>
      <div class="sectionBd"><div class="pre" id="vNotes"></div></div>
    </div>

    <!-- Edit panel (only shows if you click Edit) -->
    <div class="editPanel" id="editPanel">
      <div class="sectionHd">
        <div class="h2">Edit recipe</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
          <button class="btn small" id="cancelEditBtn">Cancel</button>
          <button class="btn small primary" id="saveEditBtn">Save</button>
        </div>
      </div>
      <div class="sectionBd">
        <div class="two">
          <div>
            <div class="k">Title</div>
            <input id="eTitle"/>
          </div>
          <div>
          <div class="k">Cuisine</div>
          <input id="eCuisine" placeholder="Mexican (optional)" autocomplete="off"/>
          <div class="suggestRow" id="cuisineSuggestions"></div>

          </div>
        </div>

        <div class="two" style="margin-top:10px;">
          <div>
            <div class="k">Appliances (comma)</div>
            <input id="eAppliances" placeholder="instant pot, oven"/>
          </div>
          <div>
            <div class="k">Time (minutes)</div>
            <input id="eTime" type="number" min="0" step="5" placeholder="30"/>
          </div>
        </div>

        <div class="two" style="margin-top:10px;">
          <div>
            <div class="k">Dishes created</div>
            <input id="eDishes" type="number" min="0" step="1" placeholder="2"/>
          </div>
          <div>
            <div class="k">Tags (comma)</div>
<input id="eTags" placeholder="weeknight, spicy, instant pot" autocomplete="off"/>
<div class="suggestRow" id="tagSuggestions"></div>

          </div>
        </div>

        <div class="two" style="margin-top:10px;">
          <div>
            <div class="k">Cooked count (editable)</div>
            <input id="eCookedCount" type="number" min="0" step="1" placeholder="0"/>
          </div>
          <div>
            <div class="k">Servings</div>
            <input id="eServings" placeholder="yields 4"/>
          </div>
        </div>

        <div style="margin-top:10px;">
          <div class="k">Image path</div>
          <input id="eImageUrl" placeholder="images/yourfile.jpg"/>
        </div>

        <div style="margin-top:10px;">
          <div class="k">Source URL</div>
          <input id="eSourceUrl" placeholder="https://…"/>
        </div>

        <div style="margin-top:10px;">
          <div class="k">Ingredients</div>
          <textarea id="eIngredients"></textarea>
        </div>
        <div style="margin-top:10px;">
          <div class="k">Directions</div>
          <textarea id="eDirections"></textarea>
        </div>
        <div style="margin-top:10px;">
          <div class="k">Notes</div>
          <textarea id="eNotes"></textarea>
        </div>

        <div class="hint" style="margin-top:10px;" id="editStats"></div>
      </div>
    </div>

    <div class="viewerFooterSpace"></div>
  </div>
</div>

<!-- Snackbar -->
<div id="snack" class="snack" aria-live="polite">
  <span id="snackMsg" class="snackMsg"></span>
  <button id="snackUndo" class="btn small">Undo</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import {
    getFirestore,
    collection,
    getDocs,
    writeBatch,
    doc,
    onSnapshot,
    query
  } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAFgODyKQFacEO3xfslhTeeU4n2hKcAy2s",
    authDomain: "jake-recipes.firebaseapp.com",
    projectId: "jake-recipes",
    storageBucket: "jake-recipes.firebasestorage.app",
    messagingSenderId: "337488882837",
    appId: "1:337488882837:web:78b7ad6a163eaac4b3bf9c",
    measurementId: "G-1PQX8MWL3J"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Minimal helpers exposed to your existing (non-module) script
  window.FB = {
    enabled: true,

    async loadAll(){
      const snap = await getDocs(collection(db, "recipes"));
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    },

    // Make cloud exactly match local (writes all + deletes removed docs)
    async syncAll(recipes){
      const col = collection(db, "recipes");
      const snap = await getDocs(col);

      const existingIds = new Set(snap.docs.map(d => d.id));
      const desiredIds = new Set((recipes || []).map(r => r?.id).filter(Boolean));

      const batch = writeBatch(db);

      // Delete docs that no longer exist locally
      for(const id of existingIds){
        if(!desiredIds.has(id)){
          batch.delete(doc(col, id));
        }
      }

      // Upsert all local recipes
      for(const r of (recipes || [])){
        if(!r || !r.id) continue;
        batch.set(doc(col, r.id), r);
      }

      await batch.commit();
    },

    // Live updates from cloud
    subscribe(onData){
      const col = collection(db, "recipes");
      return onSnapshot(query(col), (snap)=>{
        const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        onData(list);
      });
    }
  };
</script>

<script>

  const SITE_JSON = "./recipes.json";
  const LS_KEY = "recipe_vault_data_v3_gallery";
  const CHECKS_PREFIX = "rv_ing_checks_v1:"; // per-recipe checkbox state

  // Per-recipe last-used scaling (saved on this device)
  const SCALE_STORE_KEY = "rv.scaleById.v1";
  
  const $ = (id)=>document.getElementById(id);
  function waitForFB(timeoutMs = 4000){
  if(window.FB && window.FB.enabled) return Promise.resolve(true);
  return new Promise((resolve)=>{
    const start = Date.now();
    const t = setInterval(()=>{
      if(window.FB && window.FB.enabled){
        clearInterval(t);
        resolve(true);
      }else if(Date.now() - start > timeoutMs){
        clearInterval(t);
        resolve(false);
      }
    }, 50);
  });
}

  const state = {
  recipes: [],
  selectedId: null,
  editOpen: false,
  scaleFactor: 1,
  baseServings: null
};


  const normalizeList = (s)=> (s||"").split(",").map(x=>x.trim()).filter(Boolean);
  const uid = ()=> Math.random().toString(36).slice(2,10) + "-" + Date.now().toString(36);

// ---- Edit suggestions (reuse + filter tags/cuisines) ----
let ALL_CUISINES = [];
let ALL_TAGS = [];

function rebuildTagCaches(){
  const cuisineSet = new Set();
  const tagSet = new Set();

  for(const r of state.recipes || []){
    const c = (r.cuisine || "").trim();
    if(c) cuisineSet.add(c);

    for(const t of (r.tags || [])){
      const tag = String(t || "").trim();
      if(tag) tagSet.add(tag);
    }
  }

  ALL_CUISINES = Array.from(cuisineSet).sort((a,b)=>a.localeCompare(b));
  ALL_TAGS = Array.from(tagSet).sort((a,b)=>a.localeCompare(b));
}

function lastTagToken(inputValue){
  const parts = String(inputValue || "").split(",");
  return (parts[parts.length - 1] || "").trim().toLowerCase();
}

function filterList(values, q){
  const qq = (q || "").trim().toLowerCase();
  if(!qq) return values;
  return values.filter(v => v.toLowerCase().includes(qq));
}

function renderSuggestChips(hostId, values, q, onPick){
  const host = $(hostId);
  if(!host) return;
  host.innerHTML = "";

  const qq = (q || "").trim();
  const filtered = filterList(values, qq).slice(0, 30);
  const shownSet = new Set(filtered.map(v => v.toLowerCase()));

  // Offer "Add" if typed value isn't already in the list
  if(qq && !shownSet.has(qq.toLowerCase())){
    const addBtn = document.createElement("button");
    addBtn.type = "button";
    addBtn.className = "chipBtn";
    addBtn.textContent = `+ Add "${qq}"`;
    addBtn.addEventListener("click", (e)=>{
      e.preventDefault();
      onPick(qq);
      rebuildTagCaches();
      refreshEditSuggestions();
    });
    host.appendChild(addBtn);
  }

  filtered.forEach(v=>{
    const b = document.createElement("button");
    b.type = "button";
    b.className = "chipBtn";
    b.textContent = v;
    b.addEventListener("click", (e)=>{
      e.preventDefault();
      onPick(v);
      refreshEditSuggestions();
    });
    host.appendChild(b);
  });
}

// Replace the LAST comma token with the selected tag (smart autocomplete behavior)
function replaceLastTagTokenWith(tag){
  const input = $("eTags");
  if(!input) return;

  const wanted = String(tag).trim().toLowerCase();
  if(!wanted) return;

  const parts = String(input.value || "").split(",");
  parts[parts.length - 1] = " " + wanted;

  const normalized = normalizeList(parts.join(",").toLowerCase());
  input.value = normalized.join(", ") + ", "; // keeps typing flow
}

function refreshEditSuggestions(){
  // Cuisine: filter by full input
  const cuisineQ = ($("eCuisine")?.value || "").trim();

  // Tags: filter by last token you're typing
  const tagQ = lastTagToken($("eTags")?.value || "");

  renderSuggestChips("cuisineSuggestions", ALL_CUISINES, cuisineQ, (c)=>{
    $("eCuisine").value = c;
  });

  renderSuggestChips("tagSuggestions", ALL_TAGS, tagQ, (t)=>{
    replaceLastTagTokenWith(t);
  });
}


  function setStatus(msg){ $("status").textContent = msg ? ("— " + msg) : ""; }
  function toast(msg){ setStatus(msg); setTimeout(()=>setStatus(""), 1200); }

  function setCloudStatus(){
  const el = $("cloud");
  if(!el) return;
  const on = !!(window.FB && window.FB.enabled);
  el.textContent = on
    ? `cloud: yes • recipes: ${state.recipes.length}`
    : `cloud: no • recipes: ${state.recipes.length}`;
}




  // Snackbar (Undo)
  let snackTimer = null;
  let undoFn = null;

  function showSnack(message, onUndo){
    $("snackMsg").textContent = message;
    undoFn = onUndo || null;

    const btn = $("snackUndo");
    btn.style.display = undoFn ? "" : "none";

    $("snack").classList.add("show");
    if(snackTimer) clearTimeout(snackTimer);
    snackTimer = setTimeout(hideSnack, 5000);
  }

  function hideSnack(){
    $("snack").classList.remove("show");
    undoFn = null;
    if(snackTimer) clearTimeout(snackTimer);
    snackTimer = null;
  }

let fbSyncTimer = null;

function scheduleFirebaseSync(){
  if(!window.FB || !window.FB.enabled) return;
  if(fbSyncTimer) clearTimeout(fbSyncTimer);

  fbSyncTimer = setTimeout(async ()=>{
    try{
      await window.FB.syncAll(state.recipes);
      // keep it quiet (no toast spam)
    }catch(e){
      console.warn("Firebase sync failed", e);
      toast("cloud sync failed");
    }
  }, 800);
}

function saveLocal(opts={}){
  localStorage.setItem(LS_KEY, JSON.stringify(state.recipes));
  rebuildTagCaches();
  refreshEditSuggestions();

  if(!opts.skipCloud) scheduleFirebaseSync();
}


  function loadLocal(){
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return null;
    try{ const data = JSON.parse(raw); return Array.isArray(data)?data:null; }catch{return null;}
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

    // Cook Mode + Wake Lock (keep screen awake when supported)
  const COOKMODE_KEY = "rv.cookMode.v1";
  let wakeLockSentinel = null;

  function cookModeEnabled(){
    return document.body.classList.contains("cookMode");
  }

  async function requestWakeLock(){
    try{
      if(!("wakeLock" in navigator)) return false;
      wakeLockSentinel = await navigator.wakeLock.request("screen");
      return true;
    }catch{
      wakeLockSentinel = null;
      return false;
    }
  }

  async function releaseWakeLock(){
    try{
      if(wakeLockSentinel){
        await wakeLockSentinel.release();
        wakeLockSentinel = null;
      }
    }catch{}
  }

  async function updateCookModeUI(){
    const btn = $("cookModeBtn");
    const hint = $("wakeHint");
    const on = cookModeEnabled();

    if(btn) btn.textContent = on ? "Cook Mode: On" : "Cook Mode";

    if(!hint) return;

    const viewerOpen = $("viewer").classList.contains("show");
    if(on && !viewerOpen){
      hint.style.display = "none";
      hint.textContent = "";
      return;
    }

    if(!on){
      hint.style.display = "none";
      hint.textContent = "";
      await releaseWakeLock();
      return;
    }

    hint.style.display = "";
    hint.textContent = "Tip: keeping your screen awake while cooking…";

    const ok = await requestWakeLock();
    hint.textContent = ok
      ? "Screen awake: enabled (if supported)."
      : "Tip: set your phone's Screen Timeout longer while cooking.";
  }

  function setCookMode(on){
    document.body.classList.toggle("cookMode", !!on);
    localStorage.setItem(COOKMODE_KEY, on ? "1" : "0");
    updateCookModeUI();
  }

  document.addEventListener("visibilitychange", ()=>{
    if(document.visibilityState === "visible" && cookModeEnabled()){
      requestWakeLock();
    }
  });

  async function loadSiteData(){
    const res = await fetch(SITE_JSON, {cache:"no-store"});
    if(!res.ok) throw new Error("Failed to load recipes.json");
    const data = await res.json();
    if(!Array.isArray(data)) throw new Error("recipes.json not an array");
    const t = Date.now();
    return data.map(r => ({
      id: r.id || uid(),
      title: r.title || "(untitled)",
      cuisine: r.cuisine || "",
      appliances: Array.isArray(r.appliances) ? r.appliances : [],
      timeMinutes: (typeof r.timeMinutes === "number") ? r.timeMinutes : (r.timeMinutes ? Number(r.timeMinutes) : null),
      dishesCount: (typeof r.dishesCount === "number") ? r.dishesCount : (r.dishesCount ? Number(r.dishesCount) : null),
      tags: Array.isArray(r.tags) ? r.tags : [],
      cookedCount: Number(r.cookedCount || 0),
      lastCookedAt: r.lastCookedAt || null,
      createdAt: r.createdAt || t,
      updatedAt: r.updatedAt || t,
      imageUrl: r.imageUrl || "",
      sourceUrl: r.sourceUrl || "",
      servings: r.servings || "",
      ingredients: r.ingredients || "",
      directions: r.directions || "",
      notes: r.notes || ""
    }));
  }

  function refreshFilterOptions(){
    const cuisines = Array.from(new Set(state.recipes.map(r => (r.cuisine||"").trim()).filter(Boolean))).sort();
    const appliances = Array.from(new Set(state.recipes.flatMap(r => r.appliances||[]))).sort();

    const c = $("cuisineF"), a = $("applianceF");
    const cv=c.value,av=a.value;
    c.innerHTML = `<option value="">Any</option>` + cuisines.map(x=>`<option>${escapeHtml(x)}</option>`).join("");
    a.innerHTML = `<option value="">Any</option>` + appliances.map(x=>`<option>${escapeHtml(x)}</option>`).join("");
    if(cuisines.includes(cv)) c.value=cv;
    if(appliances.includes(av)) a.value=av;
  }

  function hay(r){
    return [
      r.title, r.cuisine,
      (r.appliances||[]).join(" "),
      (r.tags||[]).join(" "),
      r.ingredients, r.directions, r.notes
    ].join("\n").toLowerCase();
  }

  function filtered(){
    const q = $("q").value.trim().toLowerCase();
    const cuisine = $("cuisineF").value;
    const appliance = $("applianceF").value;
    const maxTime = Number($("maxTime").value||0);

    let out = state.recipes.filter(r=>{
      if(cuisine && (r.cuisine||"").trim()!==cuisine) return false;
      if(appliance && !(r.appliances||[]).includes(appliance)) return false;
      if(maxTime>0 && Number(r.timeMinutes||0)>maxTime) return false;
      if(q && !hay(r).includes(q)) return false;
      return true;
    });

    const sort = $("sort").value;
    if(sort==="updated") out.sort((a,b)=> (b.updatedAt||0)-(a.updatedAt||0));
    if(sort==="title") out.sort((a,b)=> (a.title||"").localeCompare(b.title||""));
    if(sort==="cooked") out.sort((a,b)=> (Number(b.cookedCount||0)-Number(a.cookedCount||0)));
    if(sort==="time") out.sort((a,b)=> (Number(a.timeMinutes||1e9)-Number(b.timeMinutes||1e9)));
    return out;
  }

  function setGridColumns(n){
    const grid = $("grid");
    grid.style.gridTemplateColumns = `repeat(${n}, minmax(0,1fr))`;
  }

  // Make slider intuitive: right = bigger cards (fewer columns)
  function applyCardSize(){
    const v = Number($("size").value); // 2..6
    let cols = (8 - v);                // 6..2 (right = bigger cards)

    // On small screens, keep cards big (never more than 2 columns)
    if(window.innerWidth <= 520) cols = Math.min(cols, 2);

    setGridColumns(cols);
  }

  function pill(txt){
    const s=document.createElement("span");
    s.className="pill"; s.textContent=txt; return s;
  }

  function renderGrid(){
    const arr = filtered();
    $("count").textContent = String(arr.length);

    const grid = $("grid");
    grid.innerHTML = "";

    if(arr.length===0){
      const div=document.createElement("div");
      div.className="hint";
      div.textContent="No matches. Clear filters or search.";
      grid.appendChild(div);
      return;
    }

    for(const r of arr){
      const tile = document.createElement("div");
      tile.className = "tile";
      tile.onclick = ()=> openViewer(r.id);

      const imgBox = document.createElement("div");
      imgBox.className = "imgBox";

      if(r.imageUrl){
        const img = document.createElement("img");
        img.alt = "";
        img.loading = "lazy";
        img.src = r.imageUrl;
        img.onerror = ()=>{
          img.remove();
          const fb = document.createElement("div");
          fb.className = "imgFallback";
          fb.textContent = "No image";
          imgBox.appendChild(fb);
        };
        imgBox.appendChild(img);
      } else {
        const fb = document.createElement("div");
        fb.className = "imgFallback";
        fb.textContent = "No image";
        imgBox.appendChild(fb);
      }

      const body = document.createElement("div");
      body.className = "tileBody";

      const title = document.createElement("div");
      title.className = "tileTitle";
      title.textContent = r.title || "(untitled)";

      const meta = document.createElement("div");
      meta.className = "tileMeta";

      if((r.cookedCount||0)>0){
        const b = document.createElement("span");
        b.className="badge pill";
        b.innerHTML = `<span class="dot"></span> cooked ${r.cookedCount}`;
        meta.appendChild(b);
      }
      if(r.cuisine) meta.appendChild(pill(r.cuisine));
      if(r.timeMinutes) meta.appendChild(pill(`${r.timeMinutes}m`));
      if((r.appliances||[]).length) meta.appendChild(pill(r.appliances[0]));

      // Show up to 2 tags on cards (quick glance)
      if((r.tags||[]).length){
        meta.appendChild(pill(r.tags[0]));
        if(r.tags[1]) meta.appendChild(pill(r.tags[1]));
      }


      body.appendChild(title);
      body.appendChild(meta);

      tile.appendChild(imgBox);
      tile.appendChild(body);

      grid.appendChild(tile);
    }
  }

  /* Viewer */
  function showViewer(show){
    $("overlay").classList.toggle("show", show);
    $("viewer").classList.toggle("show", show);
    $("viewer").setAttribute("aria-hidden", String(!show));
    document.body.style.overflow = show ? "hidden" : "";
  }

  function getSelected(){
    return state.recipes.find(r => r.id === state.selectedId) || null;
  }

  function openViewer(id){
    state.selectedId = id;
    state.editOpen = false;

    state.scaleFactor = 1;
    state.baseServings = null;
    $("scaleServingsTarget").value = "";

    $("editPanel").classList.remove("show");
    $("editToggleBtn").textContent = "Edit";

    renderViewer();      // computes baseServings + renders default scale
    applySavedScale();   // restores last-used scale for this recipe (if any)

    showViewer(true);

    // If Cook Mode is on, update hint + try wake lock now (user gesture is the click)
    if(cookModeEnabled()) updateCookModeUI();
  }


  function closeViewer(){
    showViewer(false);
    state.selectedId = null;
    state.editOpen = false;
    hideSnack();
    releaseWakeLock();
    const hint = $("wakeHint");
    if(hint){ hint.style.display = "none"; hint.textContent = ""; }
  }


  // Ingredients checkbox state helpers
  function checksKey(recipeId){ return CHECKS_PREFIX + recipeId; }

  function loadChecks(recipeId){
    try{
      const raw = localStorage.getItem(checksKey(recipeId));
      if(!raw) return new Set();
      const arr = JSON.parse(raw);
      if(!Array.isArray(arr)) return new Set();
      return new Set(arr);
    }catch{
      return new Set();
    }
  }

  function saveChecks(recipeId, set){
    try{
      localStorage.setItem(checksKey(recipeId), JSON.stringify(Array.from(set)));
    }catch{}
  }

    // Scale persistence helpers
  function loadScaleMap(){
    try { return JSON.parse(localStorage.getItem(SCALE_STORE_KEY) || "{}") || {}; }
    catch { return {}; }
  }

  function saveScaleForRecipe(id, data){
    const map = loadScaleMap();
    map[id] = { ...(map[id] || {}), ...data, t: Date.now() };
    localStorage.setItem(SCALE_STORE_KEY, JSON.stringify(map));
  }

  function getScaleForRecipe(id){
    const map = loadScaleMap();
    return map[id] || null;
  }

  function persistCurrentScale(){
    const r = getSelected();
    if(!r) return;

    const targetEl = $("scaleServingsTarget");
    const targetVal = Number(targetEl?.value);

    if(state.baseServings && targetVal && targetVal > 0){
      saveScaleForRecipe(r.id, { targetServings: targetVal, scaleFactor: state.scaleFactor });
    } else {
      saveScaleForRecipe(r.id, { scaleFactor: state.scaleFactor });
    }
  }

  function applySavedScale(){
    const r = getSelected();
    if(!r) return;

    const saved = getScaleForRecipe(r.id);
    if(!saved) return;

    // If we have a base servings, restore target servings if present
    if(state.baseServings && saved.targetServings){
      $("scaleServingsTarget").value = String(saved.targetServings);
      state.scaleFactor = Number(saved.targetServings) / state.baseServings;
      updateScaleUI();
      renderIngredients(r, state.scaleFactor);
      persistCurrentScale();
      return;
    }

    // Otherwise restore a raw factor
    if(saved.scaleFactor){
      state.scaleFactor = Number(saved.scaleFactor) || 1;
      updateScaleUI();
      renderIngredients(r, state.scaleFactor);
      persistCurrentScale();
    }
  }


  function parseIngredientLines(text){
    const lines = (text || "").split("\n").map(l => l.trim()).filter(l => l.length>0);
    return lines;
  }

  function stripLeadingStepNumber(s){
  // Removes "12. ", "12) ", "12: ", "12 - " and also repeated duplicates like "12. 12. ..."
  return String(s || "").replace(/^\s*(?:\d+\s*[\.\)\:\-]\s+)+/, "");
}


  // -------- Smart scaling helpers --------
const UNICODE_FRACS = {
  "¼": 1/4, "½": 1/2, "¾": 3/4,
  "⅐": 1/7, "⅑": 1/9, "⅒": 1/10,
  "⅓": 1/3, "⅔": 2/3,
  "⅕": 1/5, "⅖": 2/5, "⅗": 3/5, "⅘": 4/5,
  "⅙": 1/6, "⅚": 5/6,
  "⅛": 1/8, "⅜": 3/8, "⅝": 5/8, "⅞": 7/8
};

function parseNumberToken(tok){
  if(!tok) return null;
  tok = tok.trim();
  if(UNICODE_FRACS[tok] != null) return UNICODE_FRACS[tok];

  // "1½"
  const mMix = tok.match(/^(\d+)([¼½¾⅐⅑⅒⅓⅔⅕⅖⅗⅘⅙⅚⅛⅜⅝⅞])$/);
  if(mMix) return Number(mMix[1]) + (UNICODE_FRACS[mMix[2]] || 0);

  // "1/2"
  const mFrac = tok.match(/^(\d+)\s*\/\s*(\d+)$/);
  if(mFrac){
    const a = Number(mFrac[1]), b = Number(mFrac[2]);
    if(b) return a/b;
  }

  // "1" or "1.25"
  if(/^\d+(\.\d+)?$/.test(tok)) return Number(tok);
  return null;
}

function parseLeadingQuantity(line){
  const s = line.trim();
  if(/^##\s*/.test(s)) return null; // header line

  // range: "1-2" or "1 to 2"
  const range = s.match(/^(\S+)\s*(?:-|–|—|\bto\b)\s*(\S+)(.*)$/i);
  if(range){
    const a = parseNumberToken(range[1]);
    const b = parseNumberToken(range[2]);
    if(a != null && b != null){
      return { isRange:true, a, b, rest:(range[3]||"").trimStart() };
    }
  }

  // mixed: "1 1/2"
  const mixed = s.match(/^(\d+)\s+(\S+)(.*)$/);
  if(mixed){
    const a = Number(mixed[1]);
    const b = parseNumberToken(mixed[2]);
    if(!Number.isNaN(a) && b != null){
      return { isRange:false, v:a+b, rest:(mixed[3]||"").trimStart() };
    }
  }

  // single: "½" or "1/2" or "2"
  const single = s.match(/^(\S+)(.*)$/);
  if(single){
    const v = parseNumberToken(single[1]);
    if(v != null) return { isRange:false, v, rest:(single[2]||"").trimStart() };
  }

  return null;
}

function formatNumberSmart(n){
  if(Math.abs(n - Math.round(n)) < 0.01) return String(Math.round(n));
  // try common fraction denominators
  const dens = [2,3,4,5,6,8,10,12,16];
  const sign = n < 0 ? -1 : 1;
  n = Math.abs(n);
  const whole = Math.floor(n + 1e-9);
  const frac = n - whole;

  let best = null;
  for(const d of dens){
    const num = Math.round(frac * d);
    const approx = num / d;
    const err = Math.abs(frac - approx);
    if(best == null || err < best.err) best = { num, d, err };
  }
  if(best && best.num !== 0 && best.err < 0.02){
    // reduce fraction
    const gcd = (a,b)=> b ? gcd(b, a%b) : a;
    let num = best.num, den = best.d;
    const g = gcd(num, den);
    num /= g; den /= g;
    const out = whole ? `${whole} ${num}/${den}` : `${num}/${den}`;
    return sign < 0 ? `-${out}` : out;
  }
  const dec = (sign * (whole + frac)).toFixed(2).replace(/\.00$/,"").replace(/(\.\d)0$/,"$1");
  return dec;
}

function scaleIngredientLine(line, factor){
  if(!factor || Math.abs(factor - 1) < 1e-9) return line;
  const p = parseLeadingQuantity(line);
  if(!p) return line;

  if(p.isRange){
    return `${formatNumberSmart(p.a*factor)}-${formatNumberSmart(p.b*factor)} ${p.rest}`.trim();
  }
  return `${formatNumberSmart(p.v*factor)} ${p.rest}`.trim();
}

function parseFirstNumberAnywhere(text){
  if(!text) return null;
  const m = String(text).match(/(\d+(\.\d+)?|\d+\s*\/\s*\d+|[¼½¾⅐⅑⅒⅓⅔⅕⅖⅗⅘⅙⅚⅛⅜⅝⅞])/);
  if(!m) return null;
  return parseNumberToken(m[1].replace(/\s+/g,""));
}


  function renderIngredients(r, factor = 1){
    const host = $("vIngredients");
    host.innerHTML = "";

    const lines = parseIngredientLines(r.ingredients);
    if(lines.length === 0){
      const empty = document.createElement("div");
      empty.className = "hint";
      empty.textContent = "No ingredients yet.";
      host.appendChild(empty);
      return;
    }

    const checked = loadChecks(r.id);
    let itemIndex = 0;

    const ul = document.createElement("div");
    ul.className = "ingList";

    for(const line of lines){
      if(line.startsWith("## ")){
        const hdr = document.createElement("div");
        hdr.className = "ingHeader";
        hdr.textContent = line.replace(/^##\s*/, "");
        ul.appendChild(hdr);
        continue;
      }

      const row = document.createElement("label");
      row.className = "ingItem";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      const key = String(itemIndex);
      cb.checked = checked.has(key);

      const txt = document.createElement("div");
      txt.className = "ingText" + (cb.checked ? " checked" : "");
      txt.textContent = scaleIngredientLine(line, factor);


      cb.addEventListener("change", ()=>{
        const set = loadChecks(r.id);
        if(cb.checked) set.add(key);
        else set.delete(key);
        saveChecks(r.id, set);
        txt.classList.toggle("checked", cb.checked);
      });

      row.appendChild(cb);
      row.appendChild(txt);
      ul.appendChild(row);

      itemIndex++;
    }

    host.appendChild(ul);
  }

  function renderViewer(){
    const r = getSelected();
    if(!r) return;

    $("vTitle").textContent = r.title || "(untitled)";

    const subBits = [];
    if(r.cuisine) subBits.push(r.cuisine);
    if(r.timeMinutes) subBits.push(`${r.timeMinutes} min`);
    if(r.servings) subBits.push(r.servings);
    $("vSub").textContent = subBits.join(" • ");

    // Hero image
    if(r.imageUrl){
      $("vHero").style.display = "";
      $("vImg").src = r.imageUrl;
    } else {
      $("vHero").style.display = "none";
      $("vImg").removeAttribute("src");
    }

    // Quick info pills
    const info = $("vInfo");
    info.innerHTML = "";
    if((r.appliances||[]).length) info.appendChild(pill("appliances: " + r.appliances.join(", ")));
    if(r.dishesCount != null) info.appendChild(pill("dishes: " + r.dishesCount));
    if((r.tags||[]).length) info.appendChild(pill("tags: " + r.tags.join(", ")));
    if((r.cookedCount||0)>0) info.appendChild(pill("cooked: " + r.cookedCount));

    $("vSource").innerHTML = r.sourceUrl
      ? `Source: <a href="${escapeHtml(r.sourceUrl)}" target="_blank" rel="noreferrer">${escapeHtml(r.sourceUrl)}</a>`
      : `<span class="muted">No source URL</span>`;

    state.baseServings = parseFirstNumberAnywhere(r.servings);
    updateScaleUI();
    renderIngredients(r, state.scaleFactor);



    $("vDirections").textContent = r.directions || "";

    if(r.notes && r.notes.trim()){
      $("vNotesWrap").style.display = "";
      $("vNotes").textContent = r.notes;
    } else {
      $("vNotesWrap").style.display = "none";
    }

    if(state.editOpen) fillEditForm(r);
  }

  function updateScaleUI(){
    const r = getSelected();
    if(!r) return;

    const row = $("scaleServingsRow");
    const baseEl = $("scaleServingsBase");
    const targetEl = $("scaleServingsTarget");
    const meta = $("scaleMeta");
    const resetBtn = $("scaleReset");

    const base = state.baseServings;

    if(base && base > 0){
      row.style.display = "";
      baseEl.textContent = formatNumberSmart(base);

      // Default target to base if empty
      const t = Number(targetEl.value);
      const target = (t && t > 0) ? t : base;
      if(!(t && t > 0)) targetEl.value = String(base);

      state.scaleFactor = target / base;

      resetBtn.textContent = `${formatNumberSmart(state.scaleFactor)}×`;
      meta.textContent = `Scaled to ${formatNumberSmart(target)} servings (${formatNumberSmart(state.scaleFactor)}×)`;
    } else {
      row.style.display = "none";
      resetBtn.textContent = `${formatNumberSmart(state.scaleFactor)}×`;
      meta.textContent = `Scale: ${formatNumberSmart(state.scaleFactor)}×`;
    }
  }


  /* Editing (only on demand) */
  function fillEditForm(r){
    $("eTitle").value = r.title || "";
    $("eCuisine").value = r.cuisine || "";
    $("eAppliances").value = (r.appliances||[]).join(", ");
    $("eTime").value = r.timeMinutes ?? "";
    $("eDishes").value = r.dishesCount ?? "";
    $("eTags").value = (r.tags||[]).join(", ");
    $("eImageUrl").value = r.imageUrl || "";
    $("eSourceUrl").value = r.sourceUrl || "";
    $("eServings").value = r.servings || "";
    $("eIngredients").value = r.ingredients || "";
    $("eDirections").value = r.directions || "";
    $("eNotes").value = r.notes || "";
    $("eCookedCount").value = Number(r.cookedCount||0);

    const parts = [
      `Updated: ${new Date(r.updatedAt||r.createdAt).toLocaleString()}`,
      `Cooked: ${r.cookedCount||0}`,
      r.lastCookedAt ? `Last cooked: ${new Date(r.lastCookedAt).toLocaleString()}` : ""
    ].filter(Boolean);
    $("editStats").textContent = parts.join(" • ");

    refreshEditSuggestions();

  }

  function toggleEdit(){
    const r = getSelected();
    if(!r) return;

    state.editOpen = !state.editOpen;
    $("editPanel").classList.toggle("show", state.editOpen);
    $("editToggleBtn").textContent = state.editOpen ? "Close edit" : "Edit";

    if(state.editOpen){
      fillEditForm(r);
      setTimeout(()=> $("editPanel").scrollIntoView({behavior:"smooth", block:"start"}), 50);
    }
  }

  function saveEdit(){
    const r = getSelected();
    if(!r) return;
    const idx = state.recipes.findIndex(x=>x.id===r.id);
    if(idx<0) return;

    const t = Date.now();
    const cookedCount = Math.max(0, Number($("eCookedCount").value || 0));

    const updated = {
      ...state.recipes[idx],
      title: ($("eTitle").value.trim() || "(untitled)"),
      cuisine: $("eCuisine").value.trim(),
      appliances: normalizeList($("eAppliances").value.toLowerCase()),
      timeMinutes: $("eTime").value ? Number($("eTime").value) : null,
      dishesCount: $("eDishes").value ? Number($("eDishes").value) : null,
      tags: normalizeList($("eTags").value.toLowerCase()),
      imageUrl: $("eImageUrl").value.trim(),
      sourceUrl: $("eSourceUrl").value.trim(),
      servings: $("eServings").value.trim(),
      ingredients: $("eIngredients").value.trim(),
      directions: $("eDirections").value.trim(),
      notes: $("eNotes").value.trim(),
      cookedCount: cookedCount,
      updatedAt: t
    };

    state.recipes[idx] = updated;
    saveLocal();
    refreshFilterOptions();
    renderGrid();
    renderViewer();
    refreshEditSuggestions();
    toast("saved locally");

  }

  // Cooked +1 with cooldown + Undo snackbar
  function markCooked(){
    const r = getSelected();
    if(!r) return;
    const idx = state.recipes.findIndex(x=>x.id===r.id);
    if(idx<0) return;

    const btn = $("markCookedBtn");
    if(btn.disabled) return; // prevent stacking
    btn.disabled = true;
    setTimeout(()=>btn.disabled=false, 1500);

    const t = Date.now();
    state.recipes[idx].cookedCount = Number(state.recipes[idx].cookedCount||0) + 1;
    state.recipes[idx].lastCookedAt = t;
    state.recipes[idx].updatedAt = t;
    saveLocal();
    renderGrid();
    renderViewer();

    showSnack("Cooked +1", () => {
      const j = state.recipes.findIndex(x=>x.id===r.id);
      if(j<0) return;
      state.recipes[j].cookedCount = Math.max(0, Number(state.recipes[j].cookedCount||0) - 1);
      state.recipes[j].updatedAt = Date.now();
      saveLocal();
      renderGrid();
      renderViewer();
      toast("undid cooked");
    });
  }

  function deleteRecipe(){
    const r = getSelected();
    if(!r) return;
    if(!confirm(`Delete "${r.title}"?`)) return;
    state.recipes = state.recipes.filter(x=>x.id!==r.id);
    saveLocal();
    refreshFilterOptions();
    renderGrid();
    toast("deleted");
    closeViewer();
  }

  function newRecipe(){
    const t = Date.now();
    const r = {
      id: uid(),
      title: "New Recipe",
      cuisine: "",
      appliances: [],
      timeMinutes: null,
      dishesCount: null,
      tags: [],
      cookedCount: 0,
      lastCookedAt: null,
      createdAt: t,
      updatedAt: t,
      imageUrl: "",
      sourceUrl: "",
      servings: "",
      ingredients: "",
      directions: "",
      notes: ""
    };
    state.recipes.unshift(r);
    saveLocal();
    refreshFilterOptions();
    renderGrid();
    openViewer(r.id);
    state.editOpen = true;
    $("editPanel").classList.add("show");
    $("editToggleBtn").textContent = "Close edit";
    fillEditForm(r);
    toast("new recipe");
  }

  /* Download a single-recipe offline page */
  function sanitizeFileName(s){
    return (s || "recipe").toLowerCase()
      .replace(/[^a-z0-9]+/g, "_")
      .replace(/^_+|_+$/g, "")
      .slice(0, 60) || "recipe";
  }

  function recipeToStandaloneHTML(r, factor = 1){
    const title = escapeHtml(r.title || "Recipe");

    // Absolute image URL so the downloaded HTML can still load images while online
    const imgUrl = r.imageUrl ? new URL(r.imageUrl, location.href).toString() : "";
    const img = imgUrl ? `<img src="${escapeHtml(imgUrl)}" alt="" />` : "";

    const source = r.sourceUrl
      ? `<p class="muted">Source: <a href="${escapeHtml(r.sourceUrl)}" target="_blank" rel="noreferrer">${escapeHtml(r.sourceUrl)}</a></p>`
      : "";

    const infoBits = [];
    if(r.cuisine) infoBits.push(escapeHtml(r.cuisine));
    if(r.timeMinutes) infoBits.push(`${Number(r.timeMinutes)} min`);
    if(r.servings) infoBits.push(escapeHtml(r.servings));
    if(Math.abs((factor||1) - 1) > 1e-9) infoBits.push(`Scaled: ${escapeHtml(formatNumberSmart(factor))}×`);
    if((r.appliances||[]).length) infoBits.push(`Appliances: ${escapeHtml(r.appliances.join(", "))}`);
    if((r.tags||[]).length) infoBits.push(`Tags: ${escapeHtml(r.tags.join(", "))}`);
    const info = infoBits.length ? `<div class="meta">${infoBits.join(" • ")}</div>` : "";

    function ingredientsHTML(){
      const lines = parseIngredientLines(r.ingredients || "");
      if(lines.length === 0) return `<div class="muted">No ingredients yet.</div>`;

      let out = `<ul>`;
      for(const line of lines){
        if(line.startsWith("## ")){
          out += `</ul><h3>${escapeHtml(line.replace(/^##\\s*/, ""))}</h3><ul>`;
          continue;
        }
        out += `<li>${escapeHtml(scaleIngredientLine(line, factor))}</li>`;
      }
      out += `</ul>`;
      return out;
    }

    function directionsHTML(){
      const lines = parseIngredientLines(r.directions || "");
      if(lines.length === 0) return `<div class="muted">No directions yet.</div>`;

      let out = `<ol>`;
      for(const line of lines){
        if(line.startsWith("## ")){
          out += `</ol><h3>${escapeHtml(line.replace(/^##\\s*/, ""))}</h3><ol>`;
          continue;
        }
        out += `<li>${escapeHtml(stripLeadingStepNumber(line))}</li>`;
      }
      out += `</ol>`;
      return out;
    }

    const notesHTML = (r.notes && r.notes.trim())
      ? `<div class="sec"><div class="pad"><h2>Notes</h2><pre>${escapeHtml(r.notes)}</pre></div></div>`
      : "";

    return `<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>${title}</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:0;background:#0b0c10;color:#eef2ff;padding:16px}
  .card{max-width:900px;margin:0 auto;background:#12141b;border:1px solid rgba(255,255,255,.12);border-radius:16px;overflow:hidden}
  .pad{padding:14px}
  h1{margin:0;font-size:20px}
  .meta{margin-top:8px;color:rgba(238,242,255,.72);font-size:12px;line-height:1.4}
  img{width:100%;display:block;max-height:420px;object-fit:cover}
  h2{font-size:14px;margin:0}
  h3{font-size:13px;margin:14px 0 8px}
  .sec{margin-top:12px;border-top:1px solid rgba(255,255,255,.10)}
  .sec .pad{padding-top:12px}
  ul,ol{margin:10px 0 0; padding-left:20px}
  li{margin:6px 0; line-height:1.5}
  pre{white-space:pre-wrap;line-height:1.55;font-size:14px;margin:8px 0 0}
  .muted{color:rgba(238,242,255,.65);font-size:12px}
  .btnbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  button{border:1px solid rgba(255,255,255,.14);background:#171a23;color:#eef2ff;padding:10px 12px;border-radius:12px;font-weight:800;cursor:pointer}
  @media print{ .btnbar{display:none} body{padding:0} .card{border:none;border-radius:0} }
</style>
</head>
<body>
  <div class="card">
    ${img}
    <div class="pad">
      <h1>${title}</h1>
      ${info}
      ${source}
      <div class="btnbar">
        <button onclick="window.print()">Print</button>
      </div>
      <p class="muted">Tip: save this file and open it anytime. Images will load while online (linked to your hosted site).</p>
    </div>
    <div class="sec"><div class="pad"><h2>Ingredients</h2>${ingredientsHTML()}</div></div>
    <div class="sec"><div class="pad"><h2>Directions</h2>${directionsHTML()}</div></div>
    ${notesHTML}
  </div>
</body>
</html>`;
  }

function recipeToPrintHTML(r, factor = 1){
  const title = escapeHtml(r.title || "Recipe");

  const infoBits = [];
  if(r.cuisine) infoBits.push(escapeHtml(r.cuisine));
  if(r.timeMinutes) infoBits.push(`${Number(r.timeMinutes)} min`);
  if(r.servings) infoBits.push(escapeHtml(r.servings));
  if(Math.abs((factor||1) - 1) > 1e-9) infoBits.push(`Scaled: ${escapeHtml(formatNumberSmart(factor))}×`);
  const info = infoBits.length ? `<div class="meta">${infoBits.join(" • ")}</div>` : "";

  function ingredientsHTML(){
    const lines = parseIngredientLines(r.ingredients || "");
    if(lines.length === 0) return `<div class="muted">—</div>`;
    const lis = lines.map(line => {
      const scaled = scaleIngredientLine(line, factor);
      return `<li>${escapeHtml(scaled)}</li>`;
    }).join("");
    return `<ul class="list">${lis}</ul>`;
  }

  function directionsHTML(){
    const lines = parseIngredientLines(r.directions || r.instructions || "");
    if(lines.length === 0) return `<div class="muted">—</div>`;

    let out = `<ol class="steps">`;
    for(const line of lines){
      if(line.startsWith("## ")){
        out += `</ol><h3>${escapeHtml(line.replace(/^##\\s*/, ""))}</h3><ol class="steps">`;
        continue;
      }
      out += `<li>${escapeHtml(stripLeadingStepNumber(line))}</li>`;
    }
    out += `</ol>`;
    return out;
  }

  const notes = (r.notes || "").trim();
  const notesHTML = notes
    ? `<div class="notes"><h2>Notes</h2><div class="noteText">${escapeHtml(notes).replace(/\n/g,"<br>")}</div></div>`
    : "";

  return `<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>${title}</title>
<style>
  :root{ color-scheme: light; }
  html, body{ margin:0; padding:0; background:#fff; color:#000; }
  body{
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    line-height: 1.22;
    font-size: 10.5pt; /* smaller to fit more */
  }

  .page{ padding: 14px 14px 16px; }

  h1{
    margin: 0 0 6px;
    font-size: 16pt;
    line-height: 1.1;
  }

  .meta{
    margin: 0 0 10px;
    font-size: 10pt;
  }

  /* Single-column stack: Ingredients then Directions (no grid gaps) */
  .stack{ display:block; }

  .box{
    border: 1px solid #000;
    border-radius: 10px;
    padding: 10px 10px 8px;
    margin: 0 0 10px;
  }

  h2{ margin: 0 0 6px; font-size: 12pt; }
  h3{ margin: 10px 0 6px; font-size: 11pt; }

  .list{ margin: 0; padding-left: 16px; }
  .list li{ margin: 0 0 3px; }

  .steps{ margin: 0; padding-left: 18px; }
  .steps li{ margin: 0 0 5px; }

  .notes{ margin-top: 10px; }
  .noteText{ font-size: 10pt; }

  .muted{ color:#000; }

  /* IMPORTANT: allow natural flowing across pages (prevents giant gaps) */
  .box, .notes, li{ break-inside: auto; page-break-inside: auto; }
  h1, h2, h3{ break-after: avoid; page-break-after: avoid; }

  /* Print rules */
  @page { margin: 0.45in; }
  @media print{
    .page{ padding: 0; }
    a{ color:#000; text-decoration:none; }
  }
</style>
</head>
<body>
  <div class="page">
    <h1>${title}</h1>
    ${info}

    <div class="stack">
      <div class="box">
        <h2>Ingredients</h2>
        ${ingredientsHTML()}
      </div>

      <div class="box">
        <h2>Directions</h2>
        ${directionsHTML()}
      </div>
    </div>

    ${notesHTML}
  </div>
</body>
</html>`;
}




  function downloadOne(){
    const r = getSelected();
    if(!r) return;
    const html = recipeToStandaloneHTML(r, state.scaleFactor || 1);

    const blob = new Blob([html], {type:"text/html"});
    const url = URL.createObjectURL(blob);
    // iPhone/iPad Safari often blocks automatic downloads.
// Fallback: open the file in a new tab so user can Share → Save to Files.
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
if(isIOS){
  window.open(url, "_blank");
  toast("Opened recipe card — use Share → Save to Files");
  return;
}

    const a = document.createElement("a");
    a.href = url;
    a.download = sanitizeFileName(r.title) + ".html";
    a.click();
setTimeout(()=>URL.revokeObjectURL(url), 60000);

    toast("downloaded recipe page");
  }


function printCard(){
  const r = getSelected(); 
  if(!r) return;

  const html = recipeToPrintHTML(r, state.scaleFactor || 1);


  const blob = new Blob([html], {type:"text/html;charset=utf-8"});
  const url = URL.createObjectURL(blob);

  const w = window.open(url, "_blank");
  if(!w){
    toast("Popup blocked — allow popups to print");
    return;
  }

  // Try to trigger print after it loads (some iOS browsers may block auto-print)
  const t = setInterval(()=>{
    try{
      if(w.document && w.document.readyState === "complete"){
        clearInterval(t);
        setTimeout(()=>{
          w.focus();
          try{ w.print(); }catch(e){}
          toast("opened print card");
        }, 250);
      }
    }catch(e){
      clearInterval(t);
    }
  }, 100);

  setTimeout(()=>URL.revokeObjectURL(url), 60000);
}



  /* Groceries export (Apple Reminders-friendly) */
  function groceriesLines(r){
    const lines = parseIngredientLines(r.ingredients)
      .filter(l => !l.startsWith("## "))
      .map(l => l.replace(/^[-*•]\s+/, "").trim())
      .filter(Boolean);
    return lines;
  }

  async function copyGroceries(){
    const r = getSelected();
    if(!r) return;
    const lines = groceriesLines(r);
    const text = lines.join("\n");
    if(!text){
      toast("no ingredients to copy");
      return;
    }
    try{
      await navigator.clipboard.writeText(text);
      toast("copied groceries");
      showSnack("Copied ingredients (paste into Reminders)", null);
    }catch{
      // fallback: prompt
      window.prompt("Copy groceries:", text);
    }
  }

  function downloadGroceriesTxt(){
    const r = getSelected();
    if(!r) return;
    const lines = groceriesLines(r);
    const text = lines.join("\n");
    if(!text){
      toast("no ingredients to download");
      return;
    }
    const blob = new Blob([text], {type:"text/plain"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = sanitizeFileName(r.title) + "_groceries.txt";
    a.click();
    URL.revokeObjectURL(url);
    toast("downloaded groceries");
  }

  /* Data import/export */
  function downloadJSON(){
    const blob=new Blob([JSON.stringify(state.recipes,null,2)], {type:"application/json"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url; a.download="recipes.json"; a.click();
    URL.revokeObjectURL(url);
    toast("downloaded JSON");
  }

  async function resetToSite(){
    if(!confirm("Reset to site data? This will overwrite local edits on this device.")) return;
    const data = await loadSiteData();
    state.recipes = data;
    saveLocal();
    refreshFilterOptions();
    renderGrid();
    toast("reset");
  }

  async function importJSON(file){
    const text = await file.text();
    const data = JSON.parse(text);
    if(!Array.isArray(data)) throw new Error("Invalid JSON");
    state.recipes = data;
    saveLocal();
    refreshFilterOptions();
    renderGrid();
    toast("imported");
  }

  async function init(){
    // Service worker (offline + faster repeat loads)
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker
        .register("sw.js", { scope: "./" })
        .catch(() => {});
}


// Fast start: local cache or recipes.json
const local = loadLocal();
if(local){
  state.recipes = local;
  toast("loaded local cache");
}else{
  state.recipes = await loadSiteData();
  saveLocal({skipCloud:true}); // don't push until Firebase confirms
  toast("loaded recipes.json");
}

refreshFilterOptions();
rebuildTagCaches();
refreshEditSuggestions();

// Cloud sync (Firebase / Firestore)
await waitForFB();
if(window.FB && window.FB.enabled){
  try{
    const cloud = await window.FB.loadAll();

    if(cloud && cloud.length){
      // Cloud is source of truth
      state.recipes = cloud;
      saveLocal({skipCloud:true});
      refreshFilterOptions();
      rebuildTagCaches();
      refreshEditSuggestions();
      toast("synced from cloud");
    }else{
      // First time: seed cloud with what we have
      await window.FB.syncAll(state.recipes);
      toast("cloud ready");
    }

    // Live updates from other devices
    if(window.FB.unsubscribe) window.FB.unsubscribe();
    window.FB.unsubscribe = window.FB.subscribe((list)=>{
      // don't overwrite while you're actively editing
      if(state.editOpen) return;

      state.recipes = list || [];
      saveLocal({skipCloud:true});
      refreshFilterOptions();
      rebuildTagCaches();
      refreshEditSuggestions();
      setCloudStatus();
      renderGrid();
      if(state.selectedId) renderViewer();
    });

  }catch(e){
    console.warn("Firebase load/subscribe failed", e);
    toast("cloud offline");
  }
}




    // Hook filters
    ["q","cuisineF","applianceF","maxTime","sort"].forEach(id=>{
      $(id).addEventListener("input", renderGrid);
      $(id).addEventListener("change", renderGrid);
    });

    // Card size slider (inverted: right = bigger cards)
    $("size").addEventListener("input", applyCardSize);
    window.addEventListener("resize", applyCardSize);
    applyCardSize();


    $("newBtn").onclick = newRecipe;


    // Viewer buttons
    $("overlay").onclick = closeViewer;
    $("backBtn").onclick = closeViewer;
    $("editToggleBtn").onclick = toggleEdit;
    $("cancelEditBtn").onclick = toggleEdit;
    $("saveEditBtn").onclick = saveEdit;
// Live-filter suggestions as you type in edit fields
$("eCuisine").addEventListener("input", refreshEditSuggestions);
$("eTags").addEventListener("input", refreshEditSuggestions);
$("eCuisine").addEventListener("focus", refreshEditSuggestions);
$("eTags").addEventListener("focus", refreshEditSuggestions);

    $("markCookedBtn").onclick = markCooked;
    $("deleteBtn").onclick = deleteRecipe;
    $("downloadOneBtn").onclick = downloadOne;
    $("printBtn").onclick = printCard;
    $("copyGroceriesBtn").onclick = copyGroceries;
    $("downloadGroceriesBtn").onclick = downloadGroceriesTxt;

        // Cook mode
    setCookMode(localStorage.getItem(COOKMODE_KEY) === "1");
    $("cookModeBtn").onclick = ()=>{
      setCookMode(!cookModeEnabled());
    };


    // Scale controls
    $("scaleDown").onclick = ()=>{
      const r = getSelected(); if(!r) return;

      if(state.baseServings){
        const el = $("scaleServingsTarget");
        const v = Math.max(0.5, (Number(el.value) || state.baseServings) - 1);
        el.value = String(v);
      } else {
        state.scaleFactor = Math.max(0.125, state.scaleFactor / 2);
      }

      updateScaleUI();
      renderIngredients(r, state.scaleFactor);
      persistCurrentScale();
    };

    $("scaleUp").onclick = ()=>{
      const r = getSelected(); if(!r) return;

      if(state.baseServings){
        const el = $("scaleServingsTarget");
        const v = (Number(el.value) || state.baseServings) + 1;
        el.value = String(v);
      } else {
        state.scaleFactor = Math.min(16, state.scaleFactor * 2);
      }

      updateScaleUI();
      renderIngredients(r, state.scaleFactor);
      persistCurrentScale();
    };

    $("scaleReset").onclick = ()=>{
      const r = getSelected(); if(!r) return;

      state.scaleFactor = 1;
      if(state.baseServings){
        $("scaleServingsTarget").value = String(state.baseServings);
      }

      updateScaleUI();
      renderIngredients(r, state.scaleFactor);
      persistCurrentScale();
    };

    $("scaleServingsTarget").addEventListener("input", ()=>{
      const r = getSelected(); if(!r) return;
      if(!state.baseServings) return;

      updateScaleUI();
      renderIngredients(r, state.scaleFactor);
      persistCurrentScale();
  });


    // Snackbar undo
    $("snackUndo").onclick = () => { if(undoFn) undoFn(); hideSnack(); };

    // ESC to close viewer on desktop
    window.addEventListener("keydown", (e)=>{
      if(e.key==="Escape" && $("viewer").classList.contains("show")){
        closeViewer();
      }
    });

    setCloudStatus();
    renderGrid();
    refreshEditSuggestions();

  }


  init();
</script>
</body>
</html>
